# Test Design: Story 1.5 - JSON Import/Export

Date: 2025-09-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 8 (44%)
- Integration tests: 8 (44%)
- E2E tests: 2 (12%)
- Priority distribution: P0: 12, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: POST /api/import (dry‑run flag) returns diff/report; no mutation on dry‑run

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification               | Risk Mitigation |
| ------------ | ----------- | -------- | --------------------------------------- | --------------------------- | --------------- |
| 1.5-UNIT-001 | Unit        | P0       | Validate import payload schema          | Pure validation logic       | DATA-001        |
| 1.5-UNIT-002 | Unit        | P0       | Generate diff report for dry-run        | Pure diff calculation logic | OPS-001         |
| 1.5-UNIT-003 | Unit        | P0       | Validate service permission checks      | Pure authorization logic    | SEC-001         |
| 1.5-INT-001  | Integration | P0       | Dry-run produces no database mutations  | Multi-component validation  | DATA-001        |
| 1.5-INT-002  | Integration | P0       | Import with invalid service permissions | Auth + DB interaction       | SEC-001         |
| 1.5-INT-003  | Integration | P1       | Large payload dry-run performance       | Memory + DB interaction     | PERF-001        |

### AC2: Import applies changes transactionally on commit

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                 | Risk Mitigation |
| ------------ | ----------- | -------- | ------------------------------------- | ----------------------------- | --------------- |
| 1.5-UNIT-004 | Unit        | P0       | Transaction rollback logic            | Pure transaction handling     | DATA-001        |
| 1.5-UNIT-005 | Unit        | P0       | Key/translation creation validation   | Pure business logic           | DATA-002        |
| 1.5-INT-004  | Integration | P0       | Full import with transaction commit   | DB + transaction coordination | DATA-001        |
| 1.5-INT-005  | Integration | P0       | Import rollback on validation failure | DB + error handling           | DATA-001        |
| 1.5-INT-006  | Integration | P0       | Concurrent import deadlock handling   | DB + concurrency              | TECH-001        |
| 1.5-INT-007  | Integration | P1       | Large payload import performance      | DB + memory management        | PERF-001        |

### AC3: GET /api/export?service&locales round‑trips with import for basic cases

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification            | Risk Mitigation |
| ------------ | ----------- | -------- | ------------------------------------- | ------------------------ | --------------- |
| 1.5-UNIT-006 | Unit        | P0       | Export query parameter validation     | Pure validation logic    | DATA-002        |
| 1.5-UNIT-007 | Unit        | P0       | Export JSON format generation         | Pure formatting logic    | DATA-002        |
| 1.5-UNIT-008 | Unit        | P1       | Export service filtering logic        | Pure filtering algorithm | -               |
| 1.5-INT-008  | Integration | P0       | Round-trip export-import cycle        | Full system integration  | DATA-002        |
| 1.5-E2E-001  | E2E         | P1       | Complete user workflow: export-import | Critical user journey    | BUS-001         |
| 1.5-E2E-002  | E2E         | P2       | Export large dataset streaming        | Performance validation   | PERF-002        |

## Additional Risk-Based Scenarios

### Security & Authorization

| ID          | Level       | Priority | Test                                 | Justification                | Risk Mitigation |
| ----------- | ----------- | -------- | ------------------------------------ | ---------------------------- | --------------- |
| 1.5-INT-009 | Integration | P0       | Cross-service import attempt blocked | Security boundary validation | SEC-001         |

### Error Handling & Monitoring

| ID          | Level       | Priority | Test                                | Justification               | Risk Mitigation |
| ----------- | ----------- | -------- | ----------------------------------- | --------------------------- | --------------- |
| 1.5-INT-010 | Integration | P2       | Detailed error reporting validation | Error handling completeness | OPS-001         |

## Risk Coverage Matrix

### Critical Risks (Score 9)

- **DATA-001 (Mass Data Corruption)**: Covered by 1.5-UNIT-001, 1.5-INT-001, 1.5-INT-004, 1.5-INT-005, 1.5-UNIT-004
- **SEC-001 (Authorization Bypass)**: Covered by 1.5-UNIT-003, 1.5-INT-002, 1.5-INT-009

### High Risks (Score 6)

- **PERF-001 (Memory Exhaustion)**: Covered by 1.5-INT-003, 1.5-INT-007

### Medium Risks (Score 4)

- **TECH-001 (Transaction Deadlocks)**: Covered by 1.5-INT-006
- **DATA-002 (Format Incompatibility)**: Covered by 1.5-UNIT-006, 1.5-UNIT-007, 1.5-INT-008
- **OPS-001 (Error Reporting)**: Covered by 1.5-UNIT-002, 1.5-INT-010

### Low Risks (Score 2-3)

- **PERF-002 (Export Performance)**: Covered by 1.5-E2E-002
- **BUS-001 (User Expectations)**: Covered by 1.5-E2E-001

## Test Implementation Strategy

### Unit Tests (8 scenarios - 44%)

**Location**: `src/routes/api/__tests__/`

- Import/export schema validation
- Diff generation logic
- Authorization checking logic
- Transaction handling logic
- JSON format generation

### Integration Tests (8 scenarios - 44%)

**Location**: `tests/integration/api/`

- Database transaction scenarios
- Auth middleware integration
- Performance under load
- Cross-service security validation
- Round-trip data integrity

### E2E Tests (2 scenarios - 12%)

**Location**: `tests/e2e/`

- Complete user workflows
- Large dataset handling

## Data Requirements

### Test Data Sets

1. **Small Dataset**: 10 keys, 3 locales, 1 service
2. **Medium Dataset**: 100 keys, 5 locales, 2 services
3. **Large Dataset**: 1000 keys, 10 locales, 3 services
4. **Invalid Dataset**: Malformed JSON, invalid references, permission violations

### Test Services

- **test-service-1**: User has Owner permissions
- **test-service-2**: User has Editor permissions
- **test-service-3**: User has no permissions (for negative tests)

## Performance Benchmarks

### Import Performance Targets

- Small dataset (10 keys): < 100ms
- Medium dataset (100 keys): < 500ms
- Large dataset (1000 keys): < 2000ms
- Dry-run overhead: < 20% of commit time

### Export Performance Targets

- Small dataset: < 50ms
- Medium dataset: < 200ms
- Large dataset: < 1000ms (with streaming)

## Mock and Stub Strategy

### Unit Test Mocks

- Database client (Drizzle)
- Authentication middleware
- Transaction manager
- JSON parser/generator

### Integration Test Setup

- Docker Postgres database
- Test user accounts with various permissions
- Seed data for consistent test scenarios

## Test Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

1. Schema validation tests (1.5-UNIT-001, 1.5-UNIT-006)
2. Business logic tests (1.5-UNIT-002, 1.5-UNIT-004, 1.5-UNIT-005)
3. Authorization tests (1.5-UNIT-003)

### Phase 2: P0 Integration Tests

1. Database mutation tests (1.5-INT-001, 1.5-INT-004, 1.5-INT-005)
2. Security tests (1.5-INT-002, 1.5-INT-009)
3. Round-trip tests (1.5-INT-008)

### Phase 3: P1+ Tests

1. Performance tests (1.5-INT-003, 1.5-INT-007)
2. E2E workflows (1.5-E2E-001)
3. Edge cases and error handling (1.5-INT-010)

### Phase 4: P2 Tests (Optional)

1. Large dataset streaming (1.5-E2E-002)

## Automation Strategy

### CI/CD Integration

- All P0 tests must pass before deployment
- P1 tests run in parallel with deployment pipeline
- Performance tests run nightly with trend analysis
- Security tests trigger on any auth-related changes

### Test Maintenance

- Review test scenarios when AC changes
- Update performance benchmarks quarterly
- Refresh test data monthly to prevent staleness

## Quality Gates

### Definition of Done

- All P0 tests passing
- Code coverage ≥ 90% for import/export logic
- Performance benchmarks met
- Security scan passes
- All critical and high risks mitigated

### Acceptance Criteria Validation

- AC1: Dry-run functionality verified by 1.5-INT-001, 1.5-UNIT-002
- AC2: Transaction handling verified by 1.5-INT-004, 1.5-INT-005, 1.5-UNIT-004
- AC3: Round-trip compatibility verified by 1.5-INT-008, 1.5-E2E-001
