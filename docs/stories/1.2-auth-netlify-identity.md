# Story 1.2: Authentication (Netlify Identity) Integration

Status: Approved

## Story

As a user,
I want secure authentication via Netlify Identity (GoTrue),
so that only authorized users access the system.

## Acceptance Criteria

- Server routes verify GoTrue JWT (issuer/site from env)
- App metadata roles mapped into app context (§12)
- Guards/middleware enforce auth on /api/\*\* with 401/403 as appropriate

## Dev Notes

**Previous Story Insights:**

- Story 1.1 established RBAC foundation with Role and Permission tables
- Auth schema extended with per-service permissions structure
- Bootstrap data includes RBAC roles: Admin, Owner, Editor, Reviewer, Viewer
- Database connection and Drizzle setup is functional

**Authentication Architecture:**
[Source: architecture/6-authentication-authorization.md]

- Middleware: `src/lib/auth/middleware.ts` - Prefers Netlify Identity Bearer token → `verifyIdentityJWT`
- Fallback: `better-auth` session (`auth.api.getSession`) and maps to normalized user
- On failure: sets 401 and throws
- better-auth config: `src/lib/auth/auth.ts` - Drizzle adapter (Postgres), cookie cache for session perf

**Current Implementation Status:**
[Source: Existing codebase analysis]

- Netlify Identity JWT verification already implemented in `src/lib/auth/identity.ts`
- Auth middleware exists in `src/lib/auth/middleware.ts` with Bearer token support
- IdentityUser type defined with roles mapping from app_metadata
- Environment variables configured: NETLIFY_IDENTITY_SITE, NETLIFY_IDENTITY_AUD

**API Route Patterns:**
[Source: architecture/5-backend-server-routes.md]

- Framework: TanStack Start server routes via `createServerFileRoute`
- Conventions: Validate inputs with Zod; return `Response` with proper `content-type`; add auth middleware
- Current endpoints: `GET /api/keys`, `POST /api/keys` (currently without auth middleware)

**Environment Configuration:**
[Source: architecture/8-environment-configuration.md]

- Required: `DATABASE_URL`, `BETTER_AUTH_SECRET`
- Netlify Identity (optional): `NETLIFY_IDENTITY_SITE`, `NETLIFY_IDENTITY_AUD`
- Server-only env vars in `src/env/server.ts`

**File Locations:**
[Source: architecture/4-repository-structure-selected.md]

- Auth middleware: `src/lib/auth/middleware.ts`
- Identity verification: `src/lib/auth/identity.ts`
- API routes: `src/routes/api/` (following TanStack Start patterns)
- Environment: `src/env/server.ts`

**Testing Requirements:**
[Source: architecture/16-testing-strategy-early.md]

- Unit tests: Auth helpers, pure utilities and service functions
- Integration tests: Auth middleware wiring, route handler happy/edge paths
- Initial Priorities (M0): Auth middleware 401 on missing/invalid credentials
- Test structure: Colocated unit tests under `src/**/__tests__/*.test.ts`

**Technical Constraints:**
[Source: architecture/13-development-standards.md]

- TanStack Start routing and middleware patterns
- Zod validation before DB access
- Return `Response` with correct headers
- TypeScript explicit types for exported functions, avoid `any`

## Tasks / Subtasks

- [ ] **Task 1: Apply auth middleware to existing API routes** (AC: 3)
  - [ ] Update `src/routes/api/keys/index.ts` to use `authMiddleware`
  - [ ] Ensure proper 401 responses for unauthenticated requests
  - [ ] Test middleware integration with existing endpoints
  - [ ] Verify Response headers and status codes

- [ ] **Task 2: Implement role mapping from JWT app_metadata** (AC: 2)
  - [ ] Enhance `IdentityUser` context with roles from `app_metadata.roles`
  - [ ] Update middleware to extract and normalize roles
  - [ ] Add helper functions for role checking in route handlers
  - [ ] Test role extraction from various JWT payloads

- [ ] **Task 3: Validate JWT verification with environment configuration** (AC: 1)
  - [ ] Ensure `NETLIFY_IDENTITY_SITE` and `NETLIFY_IDENTITY_AUD` are properly configured
  - [ ] Test JWT verification with valid and invalid tokens
  - [ ] Validate issuer and audience claims against environment variables
  - [ ] Handle missing environment configuration gracefully

- [ ] **Task 4: Add comprehensive auth middleware tests** (AC: 1, 2, 3)
  - [ ] Unit tests for `verifyIdentityJWT` with various token formats
  - [ ] Integration tests for middleware with protected routes
  - [ ] Test 401/403 response scenarios
  - [ ] Test role mapping and context enrichment

- [ ] **Task 5: Document authentication patterns and usage**
  - [ ] Add inline documentation for middleware usage
  - [ ] Update API route examples with auth middleware
  - [ ] Document role-based access patterns for future stories

## Testing

**Authentication Testing:**

- Verify JWT verification works with valid Netlify Identity tokens
- Test middleware rejects invalid/expired tokens with 401
- Confirm fallback to better-auth sessions works correctly
- Validate environment variable configuration handling

**Middleware Integration Testing:**

- Test protected routes return 401 without authentication
- Verify authenticated requests include user context
- Test role mapping from app_metadata to user context
- Confirm Response headers and status codes are correct

**Role Mapping Testing:**

- Test extraction of roles from JWT app_metadata
- Verify normalization of user context across auth methods
- Test handling of missing or malformed role data
- Validate role context is available in route handlers

**Environment Configuration Testing:**

- Test behavior with missing NETLIFY_IDENTITY_SITE
- Verify proper error handling for configuration issues
- Test JWT verification with correct issuer/audience claims

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## Change Log

| Date       | Version | Description                                        | Author     |
| ---------- | ------- | -------------------------------------------------- | ---------- |
| 2025-01-12 | 1.0     | Story properly drafted with full technical context | SM (Bob)   |
| 2025-01-12 | 1.1     | Story validated and approved for implementation    | PO (Sarah) |

## QA Results

_To be filled by QA Agent_
