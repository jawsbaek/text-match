# Story 1.1: Data Schema & Drizzle Migrations

Status: Approved

## Story

As a developer,
I want normalized schemas and reproducible migrations for core entities,
so that we can persist and evolve product data safely.

## Acceptance Criteria

- Drizzle schemas for: Service, Namespace, Key, Translation, User, Role, Permission map, Event (audit)
- FKs/uniques align with PRD §9; enums for statuses and locales
- drizzle-kit migrations generated; up/down runnable locally and in CI
- Seed script creates minimal bootstrap data (one service, locales)

## Dev Notes

**Existing Context:**

- Current schemas: `src/lib/db/schema/auth.schema.ts`, `src/lib/db/schema/l10n.schema.ts`
- Drizzle config: `drizzle.config.ts` (configured for PostgreSQL)
- Schema index: `src/lib/db/schema/index.ts` (exports all schemas)
- DB connection: `src/lib/db/index.ts`

**Entity Details from PRD §9 (docs/prd/9-information-architecture-data-model-mvp.md):**

- Service(id, code, name, owners[]) - code must be unique
- Namespace(id, service_id, name) - scoped to service
- Key(id, service_id|null for common, namespace_id, key_name, tags[], status)
- Translation(id, key_id, locale, value, status, version, checksum)
- User(id, email), Role(id, name), Permission(map) - extend existing auth schema
- Event(id, actor, action, entity_ref, before, after, created_at) - audit trail

**Key Relationships:**

- Service → Namespace (1:many)
- Namespace → Key (1:many)
- Key → Translation (1:many)
- User ↔ Role (many:many via permissions)

**Architecture References:**

- Database setup: docs/architecture/7-database-orm.md
- Environment config: docs/architecture/8-environment-configuration.md

**Migration Strategy:**

- Use drizzle-kit to generate migrations
- Ensure rollback works on empty database
- Follow existing pattern in drizzle.config.ts

## Tasks / Subtasks

- [ ] Create l10n entity schemas (Service, Namespace, Key, Translation, Event)
- [ ] Extend auth schema for Role/Permission mapping
- [ ] Add proper relations, indexes, and foreign keys
- [ ] Define enums for statuses (draft, active, archived) and common locales
- [ ] Generate initial migration using drizzle-kit
- [ ] Test migration up/down on clean database
- [ ] Create seed script with bootstrap service and locale data
- [ ] Add schema constraint validation tests

## Testing

**Migration Testing:**

- Verify `drizzle-kit generate` creates migration files
- Test `drizzle-kit push` applies changes to database
- Validate migration rollback works on empty database
- Confirm migrations work in CI environment

**Schema Validation Tests:**

- Test required field constraints (service.code, key.key_name, etc.)
- Verify enum values are enforced (status, locales)
- Test unique constraints (service.code uniqueness)
- Validate foreign key relationships work correctly
- Attempt invalid inserts to confirm constraint enforcement

**Seed Data Testing:**

- Confirm bootstrap service is created successfully
- Verify standard locale codes are populated
- Test seed script is idempotent (can run multiple times safely)

## QA Results
