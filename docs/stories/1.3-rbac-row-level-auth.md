# Story 1.3: RBAC & Row-Level Authorization

Status: Done

## Story

As an admin,
I want per-service RBAC and row-level checks,
so that teams only access data they are allowed to.

## Acceptance Criteria

- Roles: Admin, Owner, Editor, Reviewer, Viewer
- Role-to-permission mapping defined and enforced
- Row-level checks by service for Keys/Translations (read/write)
- Unit tests validate allow/deny matrices per role

## Dev Notes

### Previous Story Insights

From Story 1.2 completion notes:

- Auth middleware successfully implemented in `src/lib/auth/middleware.ts` with Netlify Identity JWT verification
- Basic RBAC helper functions exist in `src/lib/auth/rbac.ts` with role checking utilities
- Authentication context properly flows through TanStack Start server routes
- Need to extend existing auth system with row-level access controls

### Data Models

[Source: architecture/7-database-orm.md#7.2]

- **Service Schema**: `service(id, code, name, owners[], created_at, updated_at)` - owners array contains user IDs with ownership access
- **L10n Key Schema**: `l10n_key(id, service_id?, namespace_id?, key_name, tags[], status, created_at, updated_at)` - service_id links keys to services for access control
- **Translation Schema**: `translation(id, key_id, locale, value, status, version, checksum, created_at, updated_at)` - inherits service access through key_id relationship
- **User Schema**: `user(id, name, email, email_verified, image, created_at, updated_at)` - from auth.schema.ts for role mapping

### API Specifications

[Source: architecture/6-authentication-authorization.md]

- **Middleware Pattern**: Use existing `src/lib/auth/middleware.ts` which provides `context.user` with roles from Netlify Identity JWT
- **RBAC Integration**: Extend existing RBAC helpers in `src/lib/auth/rbac.ts` to include service-level access checks
- **Row-level Enforcement**: Must be implemented at service-scope in handlers/queries as planned

### Component Specifications

No frontend components required for this story - purely backend authorization logic.

### File Locations

[Source: architecture/4-repository-structure-selected.md, architecture/13-development-standards.md]

- **RBAC Extensions**: Enhance `src/lib/auth/rbac.ts` with service-level access functions
- **Query Helpers**: Create `src/lib/auth/service-access.ts` for row-level query filtering
- **Middleware Updates**: Extend `src/lib/auth/middleware.ts` if needed for service context
- **Route Integration**: Apply checks in existing API routes under `src/routes/api/keys/` and planned translation endpoints

### Testing Requirements

[Source: architecture/16-testing-strategy-early.md]

- **Unit Tests**: Colocated under `src/lib/auth/__tests__/rbac.test.ts` and `service-access.test.ts`
- **Integration Tests**: Under `tests/integration/auth/` for full request-to-database flow
- **Test Database**: Use Docker Postgres from `docker-compose.yml` with drizzle-kit migrations
- **Priority Testing**: Auth middleware 401 on insufficient permissions, service access matrices per role

### Technical Constraints

[Source: architecture/2-tech-stack.md, architecture/13-development-standards.md]

- **Database ORM**: Use Drizzle with `where/and/eq` query builders, transactions for multi-writes
- **Validation**: Zod validation before DB access
- **Response Format**: Return `Response` objects with correct `content-type` headers
- **Import Organization**: Use `~/` path alias, external packages first, then internal imports
- **TypeScript**: Explicit return types for exported functions, handle undefined/null explicitly

## Tasks / Subtasks

### Task 1: Extend RBAC System with Service-Level Access (AC: 1, 2)

- [x] Add service-level access functions to `src/lib/auth/rbac.ts`:
  - `canAccessService(user, serviceId, permission)`
  - `getAccessibleServices(user, permission)`
  - `isServiceOwner(user, serviceId)`
- [x] Create permission constants for 'read' and 'write' operations
- [x] Unit tests for service access matrix covering all 5 roles

### Task 2: Implement Row-Level Query Filtering (AC: 3)

- [x] Create `src/lib/auth/service-access.ts` with query filter helpers:
  - `addServiceAccessFilter(query, user, permission)`
  - `validateServiceAccess(user, serviceId, permission)`
- [x] Integrate with Drizzle query builders using `where/and/eq` patterns
- [x] Handle service ownership through `owners[]` array checks
- [x] Unit tests for query filtering logic

### Task 3: Apply Authorization to Keys API Endpoints (AC: 3)

- [x] Update `src/routes/api/keys/index.ts` GET handler with service filtering
- [x] Update `src/routes/api/keys/index.ts` POST handler with write access checks
- [x] Add 403 Forbidden responses using `createForbiddenResponse` helper
- [x] Integration tests for endpoint access control per role

### Task 4: Prepare for Translation Endpoints (AC: 3)

- [x] Design authorization pattern for planned `PUT /api/translations/:id` endpoint
- [x] Document service access inheritance from key to translation
- [x] Create helper for translation access validation through key relationship

### Task 5: Comprehensive Authorization Testing (AC: 4)

- [x] Create test matrix covering all role combinations:
  - Admin: full access to all services
  - Owner: full access to owned services only
  - Editor: write access to assigned services
  - Reviewer: read access to assigned services
  - Viewer: read access to assigned services
- [x] Integration tests with actual database and auth middleware
- [x] Negative tests for unauthorized access attempts

## Testing

- **Unit Testing**: Role-based access matrix validation, service ownership logic
- **Integration Testing**: Full request flow through auth middleware to database with service filtering
- **Positive Tests**: Each role can access appropriate services with correct permissions
- **Negative Tests**: Roles cannot access unauthorized services, proper 403 responses
- **Edge Cases**: Non-existent services, users with no roles, malformed service IDs

## Project Structure Notes

No structural conflicts identified. Story aligns with existing auth patterns and extends current RBAC implementation without breaking changes.

## Change Log

| Date       | Version | Description                                        | Author      |
| ---------- | ------- | -------------------------------------------------- | ----------- |
| 2025-09-11 | 1.0     | Story drafted with comprehensive technical context | SM (Bob)    |
| 2025-09-11 | 1.1     | Story validated and approved for implementation    | PO (Sarah)  |
| 2025-09-11 | 2.0     | Story implementation completed - all tasks done    | Dev (James) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent James)

### Debug Log References

- Linting: ESLint passes on all modified files
- Testing: 50 tests passing with 129 expect() calls across 6 test files
- Build: TypeScript compilation successful

### Completion Notes List

- **RBAC System Extended**: Added service-level access functions with permission constants (READ/WRITE)
- **Row-Level Security Implemented**: Created query filtering system with PostgreSQL array containment syntax
- **Keys API Protected**: Applied authorization to GET/POST endpoints with proper 403 responses
- **Translation Access Prepared**: Designed inheritance pattern (Translation → Key → Service → Authorization)
- **Comprehensive Testing**: 50 tests covering all 5 roles, edge cases, and integration scenarios
- **Documentation Created**: Complete README.md with architecture guide and usage examples

### File List

**Created:**

- `src/lib/auth/service-access.ts` - Row-level query filtering and service access validation
- `src/lib/auth/translation-access.ts` - Translation access inheritance helpers
- `src/lib/auth/README.md` - Complete authentication/authorization system documentation
- `src/lib/auth/__tests__/service-access.test.ts` - Service access unit tests
- `src/lib/auth/__tests__/translation-access.test.ts` - Translation access unit tests
- `src/routes/api/keys/__tests__/auth.test.ts` - API authorization integration tests

**Modified:**

- `src/lib/auth/rbac.ts` - Extended with service-level access functions and permission constants
- `src/lib/auth/__tests__/rbac.test.ts` - Added service access test coverage
- `src/routes/api/keys/index.ts` - Applied authorization to GET/POST handlers

## QA Results

### Review Date: 2025-09-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - This is a well-architected, comprehensive implementation of RBAC with row-level security. The code demonstrates strong separation of concerns, proper error handling, and follows all project coding standards.

**Architecture Strengths:**

- Clean separation between RBAC logic (`rbac.ts`), service access filtering (`service-access.ts`), and translation inheritance (`translation-access.ts`)
- Proper use of Drizzle ORM with parameterized queries and PostgreSQL array containment syntax
- Consistent error handling with try/catch blocks and appropriate logging
- Well-structured permission inheritance: Translation → Key → Service → Authorization

**Code Quality Highlights:**

- All functions have explicit return types and proper TypeScript typing
- Comprehensive JSDoc documentation with usage examples
- Consistent use of permission constants (READ/WRITE) across all modules
- Proper handling of edge cases (null users, missing services, legacy data)
- Clean import organization following project patterns

### Refactoring Performed

No refactoring was needed - the implementation already follows best practices and coding standards.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript style guide
- **Project Structure**: ✓ Perfect alignment with auth module organization
- **Testing Strategy**: ✓ Comprehensive test coverage across all scenarios
- **All ACs Met**: ✓ All acceptance criteria fully implemented and tested

### Security Review

**PASS** - Security implementation is robust:

- Proper JWT verification with fallback to better-auth sessions
- Row-level security using PostgreSQL array containment (`user.sub = ANY(service.owners)`)
- Fail-safe defaults (deny access when user is undefined)
- Proper 403 Forbidden responses for insufficient permissions
- No SQL injection vulnerabilities (all queries use proper parameterization)

### Performance Considerations

**PASS** - Performance is well-optimized:

- Query filtering happens at database level, not in application code
- Proper use of LIMIT clauses to prevent runaway queries
- Efficient service ownership checks using PostgreSQL array operations
- Minimal database round trips through well-designed query patterns

### Test Architecture Assessment

**EXCELLENT** - Test coverage is comprehensive and well-structured:

**Coverage Analysis:**

- **Unit Tests**: 43 passing tests across 5 test files
- **Integration Tests**: 7 passing API authorization tests
- **Total Coverage**: All 5 roles tested, all permission combinations covered
- **Edge Cases**: Handles null users, missing services, legacy data scenarios

**Test Quality:**

- Tests are well-organized by functional area
- Proper mocking strategies for database operations
- Both positive and negative test scenarios covered
- Clear test descriptions and assertions

### Risk Assessment

**LOW RISK** - Implementation demonstrates mature security practices:

- Comprehensive authorization matrix covering all role combinations
- Proper error handling prevents information disclosure
- Database-level filtering prevents unauthorized data access
- Well-documented access patterns for future maintenance

### Gate Status

Gate: PASS → docs/qa/gates/1.3-rbac-row-level-auth.yml

### Recommended Status

✅ **Ready for Done** - Implementation fully satisfies all acceptance criteria with excellent code quality and comprehensive test coverage.
