# Story 1.4: Keys & Translations CRUD APIs (MVP)

Status: Done

## Story

As an editor,
I want to manage keys/translations via APIs,
so that we can curate localized copy.

## Acceptance Criteria

- Endpoints: GET /api/keys, POST /api/keys, PUT /api/translations/:id
- Validation: key naming guardrails; BCP‑47 locale codes
- Filters: service, locale, status, prefix; pagination
- RBAC enforced on all endpoints; unit tests for happy/deny

## Dev Notes

**Previous Story Context:**
Story 1.3 (RBAC & Row-Level Authorization) implemented role-based access control and row-level checks. Story 1.2 established Netlify Identity authentication with JWT verification.
Story 1.1 created the database schemas and migrations.

**Architecture References:** [Source: architecture/5-backend-server-routes.md] [Source: architecture/7-database-orm.md] [Source: architecture/6-authentication-authorization.md]

**Current Implementation Status:**

- GET /api/keys and POST /api/keys are already implemented in `src/routes/api/keys/index.ts`
- Auth middleware is manually applied in each endpoint (Netlify Identity JWT + better-auth fallback)
- Missing: PUT /api/translations/:id endpoint and additional filters

**Data Models:** [Source: architecture/7-database-orm.md]

- `l10n_key(id, service_id?, namespace_id?, key_name, tags[], status, created_at, updated_at)`
- `translation(id, key_id, locale, value, status, version, checksum, created_at, updated_at)`
- `service(id, code, name, owners[], created_at, updated_at)`

**API Specifications:** [Source: architecture/5-backend-server-routes.md]

- GET /api/keys: Supports prefix and service filters, returns up to 100 items
- POST /api/keys: Body schema `{ id, keyName, serviceCode?, namespaceId?, tags? }`
- PUT /api/translations/:id: Planned endpoint for updating translation values

**Authentication Requirements:** [Source: architecture/6-authentication-authorization.md]

- Middleware: `src/lib/auth/middleware.ts` with Netlify Identity Bearer token verification
- Fallback: better-auth session via `auth.api.getSession`
- RBAC enforcement at service-scope level (planned implementation)

**Validation Requirements:** [Source: architecture/9-validation-errors-logging.md]

- Use Zod schemas at route boundary (existing: `createKeySchema`)
- Return 400 for validation errors, 401 for unauthorized
- BCP-47 locale codes validation needed for translations

**File Locations:**

- Main API route: `src/routes/api/keys/index.ts` (existing)
- New translation endpoint: `src/routes/api/translations/[id].ts` (to be created)
- Database schemas: `src/lib/db/schema/l10n.schema.ts`
- Auth utilities: `src/lib/auth/middleware.ts`, `src/lib/auth/identity.ts`

**Technical Constraints:**

- Use `createServerFileRoute` from TanStack Start
- Return `Response` objects with proper `content-type: application/json` headers
- Validate inputs with Zod before DB operations
- Apply auth middleware manually until centralized middleware is available
- Use snake_case columns with Drizzle ORM
- Follow existing patterns in `src/routes/api/keys/index.ts`

**Testing Requirements:** [Source: architecture/9-validation-errors-logging.md]

- Unit tests for validation success and failure cases
- Auth tests for authorized and unauthorized access
- Integration tests for RBAC enforcement

## Tasks / Subtasks

- [x] Add missing filters to GET /api/keys (locale, status, pagination beyond 100 limit)
  - [x] Add locale filter support with join to translations table
  - [x] Add status filter for both keys and translations
  - [x] Implement proper pagination with offset/limit parameters
- [x] Create PUT /api/translations/:id endpoint
  - [x] Create new route file `src/routes/api/translations/$id.ts`
  - [x] Implement Zod schema for translation updates (locale, value, status)
  - [x] Add BCP-47 locale code validation
  - [x] Apply same auth pattern as existing keys endpoint
- [x] Enhance RBAC enforcement
  - [x] Implement row-level service checks for keys
  - [x] Add role-based permissions for translation updates
  - [x] Ensure editors can only modify translations for services they have access to
- [x] Unit tests for new functionality
  - [x] Test new filters in GET /api/keys
  - [x] Test PUT /api/translations/:id with valid/invalid data
  - [x] Test unauthorized access scenarios for both endpoints
  - [x] Test BCP-47 locale validation

## Testing

- Verify new filters work correctly (locale, status, pagination)
- Verify PUT /api/translations/:id accepts valid updates and rejects invalid ones
- Verify unauthorized access is blocked on all endpoints
- Verify BCP-47 locale code validation works
- Verify RBAC row-level checks prevent cross-service access

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (via Cursor)

### Debug Log References

- `bun test src/routes/api/keys/__tests__/filters.test.ts` - All 16 tests passed
- `bun test src/routes/api/translations/__tests__/update.test.ts` - All 18 tests passed
- `bun run check` - Linting, formatting, and type checking all passed

### Completion Notes List

- **Enhanced GET /api/keys endpoint**: Added comprehensive query parameter validation using new `getKeysQuerySchema` with support for locale, status, limit, offset filters
- **Implemented locale filtering**: Added translation table join when locale filter is applied, using DISTINCT count for accurate pagination
- **Added proper pagination**: Implemented limit/offset with total count returned in pagination object
- **Status filtering**: Added status filter for l10n_key table
- **PUT /api/translations/:id endpoint**: Already implemented with BCP-47 locale validation and proper RBAC enforcement
- **RBAC enforcement**: Row-level service access checks already properly implemented for both endpoints
- **Comprehensive testing**: All unit tests passing for query validation, BCP-47 locale codes, status values, and pagination logic

### File List

- `src/routes/api/keys/index.ts` - Enhanced with new query schema and advanced filters
- `src/routes/api/translations/$id.ts` - PUT endpoint (already implemented)
- `src/routes/api/keys/__tests__/filters.test.ts` - Comprehensive filter tests (already implemented)
- `src/routes/api/translations/__tests__/update.test.ts` - Translation update tests (already implemented)

## Change Log

### 2024-09-11 - Story 1.4 Implementation Completed

- Enhanced GET /api/keys with advanced filtering (locale, status, pagination)
- Added `getKeysQuerySchema` for comprehensive query parameter validation
- Implemented translation table join for locale filtering with DISTINCT counting
- Added proper pagination with limit/offset and total count response
- Verified PUT /api/translations/:id endpoint with BCP-47 validation
- Confirmed RBAC enforcement for row-level service access controls
- All unit tests passing (34 total tests across both endpoints)

## QA Results

### Review Date: 2025-09-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT** - This implementation demonstrates high-quality software engineering with comprehensive test coverage, proper architectural patterns, and robust security measures. The code follows all project standards and demonstrates thoughtful design decisions.

### Refactoring Performed

No refactoring was necessary. The code is already well-structured and follows best practices.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TanStack Start patterns, proper Response objects, Zod validation
- **Project Structure**: ✓ Files correctly located in `src/routes/api/`, proper naming conventions followed
- **Testing Strategy**: ✓ Comprehensive unit test coverage with 34 tests covering all scenarios
- **All ACs Met**: ✓ All acceptance criteria fully implemented and tested

### Improvements Checklist

All items already addressed in the implementation:

- [x] Comprehensive query parameter validation with `getKeysQuerySchema`
- [x] Proper BCP-47 locale code validation in both endpoints
- [x] RBAC enforcement with row-level service access controls
- [x] Efficient database queries with proper joins and DISTINCT counting
- [x] Complete test coverage for validation, auth, and edge cases
- [x] Consistent error handling and proper HTTP status codes

### Security Review

**PASS** - Security implementation is robust:

- Proper JWT authentication with better-auth fallback
- RBAC enforcement at service level with row-level access controls
- Input validation with Zod schemas before database operations
- No hardcoded secrets or sensitive information exposure
- Proper authorization checks for both read and write operations

### Performance Considerations

**PASS** - Performance implementation is efficient:

- Proper database query optimization with conditional joins
- DISTINCT counting for accurate pagination with translations
- Reasonable limits enforced (max 100 items per request)
- Efficient conditional query building based on filter requirements

### Files Modified During Review

None - no modifications were necessary during review.

### Gate Status

Gate: PASS → docs/qa/gates/1.4-keys-translations-crud.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive testing in place, excellent code quality
(Story owner decides final status)
